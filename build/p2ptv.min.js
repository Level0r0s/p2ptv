/*! p2ptv v0.4.0  */
"use strict";var P2PTV=P2PTV||{VERSION:"v0.4.0",CHANNEL:"p2ptvchannel",ICE_SERVERS:[{url:"stun:stun.l.google.com:19302"}],PC_CONSTRAINTS:{optional:[{DtlsSrtpKeyAgreement:!0}]},DC_CONSTRAINTS:{reliable:!1,id:this.CHANNEL},MAX_MESSAGE_SIZE:16384,MAX_CHUNKS_PER_MEDIA_SEGMENT:256,INIT_SEGMENT:0,MIN_INIT_SEGMENT_HEADER:9,MAX_INIT_SEGMENT_PAYLOAD:this.MAX_MESSAGE_SIZE-this.MIN_INIT_SEGMENT_HEADER,MEDIA_SEGMENT_CHUNK:1,MIN_MEDIA_SEGMENT_CHUNK_HEADER:16,MAX_MEDIA_SEGMENT_CHUNK_PAYLOAD:this.MAX_MESSAGE_SIZE-this.MIN_MEDIA_SEGMENT_CHUNK_HEADER,MEDIA_SEGMENT:2,MIN_MEDIA_SEGMENT_HEADER:9,STREAMS:{},log:function(a){if("\n"===a[a.length-1]&&(a=a.substring(0,a.length-1)),window.performance){var b=(window.performance.now()/1e3).toFixed(3);console.log(b+": "+a)}else console.log(a)},isSupported:function(a){if(!this._initialized)throw new Error("Must initialize P2PTV before checking for support");a={WebSocket:!!window.WebSocket,Blob:!!window.Blob,FileReader:!!window.FileReader,ArrayBuffer:!!window.ArrayBuffer,Float64Array:!!window.Float64Array,Uint8Array:!!window.Uint8Array,Int32Array:!!window.Int32Array,RTCPeerConnection:!!this.RTCPeerConnection,RTCSessionDescription:!!this.RTCSessionDescription,RTCIceCandidate:!!this.RTCIceCandidate,MediaSource:!!window.MediaSource},a.MediaSource&&(a.WebM_VP8=MediaSource.isTypeSupported('video/webm;codecs="vp8,vorbis"'));var b=!0;return Object.keys(a).forEach(function(c){b=b&&a[c]}),b},generateStreamId:function(){for(var a=this,b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c="",d=0;12>d;d++){var e=Math.floor(Math.random()*b.length);c+=b.substring(e,e+1)}return c in a.STREAMS?a.generateStreamId():c},RTCPeerConnection:null,RTCSessionDescription:null,RTCIceCandidate:null,detectedBrowser:"unknown",_initialized:!1,adapter:function(){this.log("P2PTV "+this.VERSION),this._initialized||(this._initialized=!0,navigator.userAgent.match(/Edge/)?(this.log("This appears to be Edge"),this.detectedBrowser="edge"):navigator.userAgent.match(/Firefox/)?(this.log("This appears to be Firefox"),this.detectedBrowser="firefox"):navigator.userAgent.match(/(OPR|Opera)/)?(this.log("This appears to be Opera"),this.detectedBrowser="opera"):navigator.userAgent.match(/Chrom(e|ium)/)?(this.log("This appears to be Chrome"),this.detectedBrowser="chrome"):(this.log("This browser may not be supported"),this.detectedBrowser="unknown"),"undefined"!=typeof window&&window.navigator?window.mozRTCPeerConnection?(this.log("has prefix: moz"),this.detectedBrowser="firefox",this.RTCPeerConnection=function(a,b){if(a&&a.iceServers){for(var c=[],d=0;d<a.iceServers.length;d++){var e=a.iceServers[d];if(e.hasOwnProperty("urls"))for(var f=0;f<e.urls.length;f++){var g={url:e.urls[f]};0===e.urls[f].indexOf("turn")&&(g.username=e.username,g.credential=e.credential),c.push(g)}else c.push(a.iceServers[d])}a.iceServers=c}return new mozRTCPeerConnection(a,b)},this.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription,this.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate):window.webkitRTCPeerConnection?(this.log("has prefix: webkit"),"opera"!==this.detectedBrowser&&(this.detectedBrowser="chrome"),this.RTCPeerConnection=function(a,b){return new webkitRTCPeerConnection(a,b)},["createOffer","createAnswer"].forEach(function(a){var b=webkitRTCPeerConnection.prototype[a];webkitRTCPeerConnection.prototype[a]=function(){var a=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var c=1===arguments.length?arguments[0]:void 0;return new Promise(function(d,e){b.apply(a,[d,e,c])})}return b.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(a){var b=webkitRTCPeerConnection.prototype[a];webkitRTCPeerConnection.prototype[a]=function(){var a=arguments,c=this;return new Promise(function(d,e){b.apply(c,[a[0],function(){d(),a.length>=2&&a[1].apply(null,[])},function(b){e(b),a.length>=3&&a[2].apply(null,[b])}])})}}),this.RTCSessionDescription=window.RTCSessionDescription||window.webkitRTCSessionDescription,this.RTCIceCandidate=window.RTCIceCandidate||window.webkitRTCIceCandidate):(this.log("Your browser doesn't appear to support WebRTC"),this.detectedBrowser("not supported")):(this.log("This does not appear to be a browser"),this.detectedBrowser="not supported"))},NOP:function(){}};P2PTV.Stream=function(a){var b=this;a=a||{},P2PTV.adapter();var c={};if(!P2PTV.isSupported(c))return P2PTV.log("Your browser does not support P2PTV "+P2PTV.VERSION),"function"==typeof a.onNoSupport&&a.onNoSupport(c),null;b._streamId=P2PTV.generateStreamId(),P2PTV.STREAMS[b._streamId]=b,b._id="",b._parents={},b._children={},b._player=new P2PTV.Player(b._streamId,a),b._pushPullWindow=new P2PTV.PushPullWindow(b,b._player),b._ws=null,b._initialized=!1;var d=a.server;if("string"!=typeof d)throw new Error("Must specify a server to connect to: "+d);return b._setupSession(d),b},P2PTV.Stream.prototype={_setupSession:function(a){var b=this;b._ws=new WebSocket(a),b._ws.binaryType="arraybuffer",b._ws.onopen=function(){P2PTV.log("connected to server"),b._ws.send(JSON.stringify({type:"init",browser:P2PTV.detectedBrowser}))},b._ws.onclose=function(){P2PTV.log("disconnected to server")},b._ws.onmessage=function(a){var c=a.data;if(c instanceof ArrayBuffer)b._pushData(c);else{var d={};try{d=JSON.parse(c)}catch(e){return void P2PTV.log(e)}b._handleMessage(d)}},b._ws.onerror=function(a){P2PTV.log("!!! WebSocket Error: "+a+" !!!")}},_handleMessage:function(a){var b=this;switch(a.type){case"handle":b._id=a.id,P2PTV.log("received id: "+b._id),b._initialized=!0;break;case"peer":var c=a.id,d=a.relation;P2PTV.log("adding peer "+c+": "+d);var e=b._setupPeerConnection(c,d);e.channel=e.pc.createDataChannel(P2PTV.DC_CONSTRAINTS),e.setupDataChannel(),"parent"===d?b._parents[c]=e:b._children[c]=e,b._makeOffer(e);break;case"offer":var c=a.id,d=a.relation;P2PTV.log("answering peer "+c+": "+d);var e=b._setupPeerConnection(c,d);e.pc.ondatachannel=function(a){e.channel=a.channel,e.setupDataChannel(),"parent"===d?b._parents[c]=e:b._children[c]=e},b._handleOffer(a,e);break;case"answer":P2PTV.log("received answer sdp from: "+a.id);var c=a.id,e=c in b._parents?b._parents[c]:b._children[c];b._handleAnswer(a,e);break;case"ice":P2PTV.log("received ice candidate from: "+a.id);var c=a.id;c in b._parents?b._handleIce(a,b._parents[c]):c in b._children&&b._handleIce(a,b._children[c])}},_pushData:function(a){var b=this;b._pushPullWindow.pushData(a);for(var c in b._children)b._children.hasOwnProperty(c)&&b._children[c].send(a)},_setupPeerConnection:function(a){var b=this,a=new Peer(b,pid,relation);return a.pc=new P2PTV.RTCPeerConnection(P2PTV.ICE_SERVERS,P2PTV.PC_CONSTRAINTS),a.pc.onicecandidate=function(c){var d=c.candidate;d&&b._ws.send(JSON.stringify({type:"ice",id:a.id,sdp:d}))},a},_makeOffer:function(a){var b=this;a.pc.createOffer(function(c){P2PTV.log("created offer for: "+a.id),a.pc.setLocalDescription(c,function(){P2PTV.log("set local description for: "+a.id);var d=a.id in b._parents?"child":"parent";b._ws.send(JSON.stringify({type:"offer",relation:d,id:a.id,sdp:c.sdp}))},b._traceErr)},b._traceErr)},_makeAnswer:function(a){var b=this;a.pc.createAnswer(function(c){P2PTV.log("created answer for: "+a.id),a.pc.setLocalDescription(c,function(){P2PTV.log("set local description answer for: "+a.id),b._ws.send(JSON.stringify({type:"answer",id:a.id,sdp:c.sdp}))},b._traceErr)},b._traceErr)},_handleOffer:function(a,b){var c=this,d=new P2PTV.RTCSessionDescription(a);b.pc.setRemoteDescription(d,function(){P2PTV.log("set remote offer description for: "+b.id),c._makeAnswer(b)},c._traceErr)},_handleAnswer:function(a,b){var c=this,d=new P2PTV.RTCSessionDescription(a);b.pc.setRemoteDescription(d,function(){P2PTV.log("set remote answer description for: "+b.id)},c._traceErr)},_handleIce:function(a,b){var c=this,d=new RTCIceCandidate(a);b.pc.addIceCandidate(d,function(){P2PTV.log("successfully added ICE candidate for: "+b.id)},c._traceErr)},_traceErr:function(a){P2PTV.log(a)}},P2PTV.Stream.prototype.constructor=P2PTV.Stream,P2PTV.Player=function(a,b){var c=this;if(b=b||{},"string"!=typeof a)throw new Error("P2PTV Player expects stream id: "+a);c._streamId=a,c._initSegmentQueue=[],c._mediaSegmentQueue=[],c._appending=!1,c._hasInitSegment=!1,c._sourceBuffer=null,c._reader=new FileReader,c._mediaSource=new MediaSource,c._setPlayerCallbacks(),c._video=document.createElement("video"),c._video.id="p2ptv-"+c._streamId,c._video.controls=!0,c._video.width=b.width||854,c._video.height=b.height||480,c._video.src=window.URL.createObjectURL(c._mediaSource),c._video.pause(),c._parentElementId=b.parentElementId;var d=document.getElementById(c._parentElementId);d?(P2PTV.log("Appending stream "+c._streamId+" to "+c._parentElementId),d.appendChild(c._video)):(P2PTV.log("Appending stream "+c._streamId+" to body"),document.body.appendChild(c._video)),setInterval(function(){!c._appending&&!c._sourceBuffer.updating&&c._mediaSegmentQueue.length>0&&(c._appending=!0,c._reader.readAsArrayBuffer(c._mediaSegmentQueue.shift()))},1e3/30)},P2PTV.Player.prototype={_setPlayerCallbacks:function(){var a=this;a._mediaSource.addEventListener("sourceopen",function(b){P2PTV.log("MediaSource event: sourceopen");var c='video/webm; codecs="vorbis,vp8"';a._sourceBuffer=a._mediaSource.addSourceBuffer(c)},!1),a._reader.onload=function(b){a._sourceBuffer.appendBuffer(new Uint8Array(b.target.result)),a._reader.readyState===FileReader.DONE&&(a._video.paused&&(P2PTV.log("playing video"),a._video.play()),a._appending=!1)}},appendInitSegment:function(a){var b=this;P2PTV.log("appending initialization segment: length="+a.byteLength+" bytes"),b._hasInitSegment?b._initSegmentQueue.push(a):b._sourceBuffer.appendBuffer(a)},appendMediaSegment:function(a,b){var c=this;b=b||0,P2PTV.log("appending media segment: timestampOffset="+b+", length="+a.size+" bytes"),c._sourceBuffer.timestampOffset=b/1e3,c._mediaSegmentQueue.push(a)}},P2PTV.Player.prototype.constructor=P2PTV.Player,P2PTV.Peer=function(a,b,c){var d=this;if(d._client=a||null,null===d._client||void 0===d._client)throw new Error("Peer expects client reference");if(d.id=b||null,"string"!=typeof d.id)throw new Error("Peer expects valid identifier");if("parent"!==c&&"child"!==c)throw new Error("Peer expects valid relation");d.isParent="parent"===c,d.isChild=!d.isParent,d.pc=null,d.channel=null},P2PTV.Peer.prototype={send:function(a){var b=this;"open"===b.channel.readyState&&b.channel.send(a)},setupDataChannel:function(){var a=this;a.channel.binaryType="arraybuffer",a.channel.onopen=function(){var b=a.channel.readyState;if(P2PTV.log(P2PTV.CHANNEL+" state is: "+b),"open"===b){var c=P2PTV.CHANNEL+" test message";P2PTV.log('sent data channel message: "'+c+'"'),a.send(c)}},a.channel.onclose=function(){var b=a.channel.readyState;P2PTV.log(P2PTV.CHANNEL+" state is: "+b)},a.isParent?a.channel.onmessage=function(b){var c=b.data;"string"==typeof c?P2PTV.log("received "+P2PTV.CHANNEL+" string: "+c):a._client._pushData(c)}:a.channel.onmessage=function(a){var b=a.data;"string"==typeof b?P2PTV.log("received "+P2PTV.CHANNEL+" string: "+b):P2PTV.log("received "+P2PTV.CHANNEL+" ArrayBuffer: "+b.byteLength+" bytes")},a.channel.onerror=function(a){P2PTV.log(P2PTV.CHANNEL+" error: "+a.toString())},P2PTV.log("setup "+P2PTV.CHANNEL)}},P2PTV.Peer.prototype.constructor=P2PTV.Peer,P2PTV.InitSegment=function(a){var b=this;a=a||{},b._timecode=a.timecode,b._start=a.start,b._data=a.data},P2PTV.InitSegment.prototype={},P2PTV.InitSegment.prototype.constructor=P2PTV.InitSegment,P2PTV.MediaSegment=function(a){var b=this;b._timecode=a.timecode,b._numChunks=a.finalIndex+1,b._chunkData=new Array(b._numChunks),b._blob=null,b._processed=[],b.addChunk(a)},P2PTV.MediaSegment.prototype={addChunk:function(a){var b=this;a.index<b._numChunks&&!b._chunkData[a.index]&&(b._chunkData[a.index]=a.data.slice(a.start),b._processed.push(a.index))},needsPull:function(){},isComplete:function(){return this._processed.length===this._numChunks},getBlob:function(a){var b=this;return null===b._blob&&(a&&(P2PTV.log("in getBlob: unshifting an initialization segment"),b._chunkData.unshift(a)),b._blob=new Blob(b._chunkData,{type:"video/webm"})),b._blob},destroy:function(){}},P2PTV.MediaSegment.prototype.constructor=P2PTV.MediaSegment,P2PTV.PushPullWindow=function(a,b){var c=this;if(c._stream=a,!c._stream)throw new Error("Must pass Stream reference to PushPullWindow");if(c._player=b,!c._player)throw new Error("Must pass Player reference to PushPullWindow");c._initialTimecode=-1,c._lastInitSegment=null,c._initSegmentHash={},c._mediaSegmentHash={}},P2PTV.PushPullWindow.prototype={pushData:function(a){this._decode(a)},_decode:function(a){var b=this,c=new Float64Array(a),d=new Uint8Array(a,8),e=new Int32Array(a),f=d[0]>>6,g=c[0];switch(f){case P2PTV.INIT_SEGMENT:var h=9+(7&d[0]);b._pushInitSegment({timecode:g,start:h,data:a});break;case P2PTV.MEDIA_SEGMENT_CHUNK:var i=7&d[0];b._pushMediaSegmentChunk({timecode:g,index:d[1],finalIndex:d[2],duration:e[3],start:i+16,data:a})}},_pushInitSegment:function(a){var b=this;b._initSegmentHash[a.timecode]=a,b._lastInitSegment=a.data.slice(a.start),b._player.appendInitSegment(b._lastInitSegment)},_pushMediaSegmentChunk:function(a){var b=this,c=null;a.timecode in b._mediaSegmentHash?(c=b._mediaSegmentHash[a.timecode],c.addChunk(a)):(c=new P2PTV.MediaSegment(a),b._mediaSegmentHash[a.timecode]=c),c.isComplete()&&(b._initialTimecode<0&&(b._initialTimecode=a.timecode),b._player.appendMediaSegment(c.getBlob(),a.timecode-b._initialTimecode))},_pushMediaSegment:function(a){},_pullInitSegment:function(a){},_pullMediaSegmentChunk:function(a,b){},reset:function(){}},P2PTV.PushPullWindow.prototype.constructor=P2PTV.PushPullWindow;