/*! p2ptv v0.2.0  */
"use strict";var P2PTV=P2PTV||{VERSION:"v0.2.0",CHANNEL:"p2ptvchannel",ICE_SERVERS:[{url:"stun:stun.l.google.com:19302"}],PC_CONSTRAINTS:{optional:[{DtlsSrtpKeyAgreement:!0}]},DC_CONSTRAINTS:{reliable:!1,id:this.CHANNEL},STREAMS:{},log:function(a){if("\n"===a[a.length-1]&&(a=a.substring(0,a.length-1)),window.performance){var b=(window.performance.now()/1e3).toFixed(3);console.log(b+": "+a)}else console.log(a)},RTCPeerConnection:null,RTCSessionDescription:null,RTCIceCandidate:null,detectedBrowser:"unknown",_initialized:!1,adapter:function(){this.log("P2PTV "+this.VERSION),this._initialized||(this._initialized=!0,navigator.userAgent.match(/Edge/)?(this.log("This appears to be Edge"),this.detectedBrowser="edge"):navigator.userAgent.match(/Firefox/)?(this.log("This appears to be Firefox"),this.detectedBrowser="firefox"):navigator.userAgent.match(/(OPR|Opera)/)?(this.log("This appears to be Opera"),this.detectedBrowser="opera"):navigator.userAgent.match(/Chrom(e|ium)/)?(this.log("This appears to be Chrome"),this.detectedBrowser="chrome"):(this.log("This browser may not be supported"),this.detectedBrowser="unknown"),"undefined"!=typeof window&&window.navigator?window.mozRTCPeerConnection?(this.log("has prefix: moz"),this.detectedBrowser="firefox",this.RTCPeerConnection=function(a,b){if(a&&a.iceServers){for(var c=[],d=0;d<a.iceServers.length;d++){var e=a.iceServers[d];if(e.hasOwnProperty("urls"))for(var f=0;f<e.urls.length;f++){var g={url:e.urls[f]};0===e.urls[f].indexOf("turn")&&(g.username=e.username,g.credential=e.credential),c.push(g)}else c.push(a.iceServers[d])}a.iceServers=c}return new mozRTCPeerConnection(a,b)},this.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription,this.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate):window.webkitRTCPeerConnection?(this.log("has prefix: webkit"),"opera"!==this.detectedBrowser&&(this.detectedBrowser="chrome"),this.RTCPeerConnection=function(a,b){return new webkitRTCPeerConnection(a,b)},["createOffer","createAnswer"].forEach(function(a){var b=webkitRTCPeerConnection.prototype[a];webkitRTCPeerConnection.prototype[a]=function(){var a=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var c=1===arguments.length?arguments[0]:void 0;return new Promise(function(d,e){b.apply(a,[d,e,c])})}return b.apply(this,arguments)}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(a){var b=webkitRTCPeerConnection.prototype[a];webkitRTCPeerConnection.prototype[a]=function(){var a=arguments,c=this;return new Promise(function(d,e){b.apply(c,[a[0],function(){d(),a.length>=2&&a[1].apply(null,[])},function(b){e(b),a.length>=3&&a[2].apply(null,[b])}])})}}),this.RTCSessionDescription=window.RTCSessionDescription||window.webkitRTCSessionDescription,this.RTCIceCandidate=window.RTCIceCandidate||window.webkitRTCIceCandidate):(this.log("Your browser doesn't appear to support WebRTC"),this.detectedBrowser("not supported")):(this.log("This does not appear to be a browser"),this.detectedBrowser="not supported"))},isSupported:function(a){if(a={},!this._initialized)throw new Error("Must initialize P2PTV before checking for support");a.supportsWebSocket=!!window.WebSocket,a.supportsRTCPeerConnection=!!this.RTCPeerConnection,a.supportsRTCSessionDescription=!!this.RTCSessionDescription,a.supportsRTCIceCandidate=!!this.RTCIceCandidate,a.supportsMediaSource=!!window.MediaSource;var b=!0;return Object.keys(a).forEach(function(c){b=b&&a[c]}),b},generateStreamId:function(){for(var a=this,b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c="",d=0;12>d;d++){var e=Math.floor(Math.random()*b.length);c+=b.substring(e,e+1)}return c in a.STREAMS?a.generateStreamId():c}};P2PTV.Stream=function(a){var b=this;a=a||{},P2PTV.adapter();var c={};if(!P2PTV.isSupported(c))return P2PTV.log("Your browser does not support P2PTV "+P2PTV.VERSION),"function"==typeof a.onNoSupport&&a.onNoSupport(c),null;b._id="",b._parents={},b._children={},b._initialized=!1,b._streamId=P2PTV.generateStreamId(),P2PTV.STREAMS[b._streamId]=b,b._player=new P2PTV.Player(b._streamId,a),b._ws=null;var d=a.server;if("string"!=typeof d)throw new Error("Must specify a server to connect to: "+d);return b._setupSession(d),b},P2PTV.Stream.prototype={_setupSession:function(a){var b=this;b._ws=new WebSocket(a),b._ws.binaryType="arraybuffer",b._ws.onopen=function(){P2PTV.log("connected to server"),b._ws.send(JSON.stringify({type:"init",browser:P2PTV.detectedBrowser}))},b._ws.onclose=function(){P2PTV.log("disconnected to server")},b._ws.onmessage=function(a){var c=a.data;if(c instanceof ArrayBuffer)b._pushData(c);else{var d={};try{d=JSON.parse(c)}catch(e){return void P2PTV.log(e)}b._handleMessage(d)}},b._ws.onerror=function(a){P2PTV.log("!!! WebSocket Error: "+a+" !!!")}},_handleMessage:function(a){var b=this;switch(a.type){case"handle":b._id=a.id,P2PTV.log("received id: "+b._id),b._initialized=!0;break;case"peer":var c=a.id,d=a.relation;P2PTV.log("adding peer "+c+": "+d);var e=b._setupPeerConnection(c,d);e.channel=e.pc.createDataChannel(P2PTV.DC_CONSTRAINTS),e.setupDataChannel(),"parent"===d?b._parents[c]=e:b._children[c]=e,b._makeOffer(e);break;case"offer":var c=a.id,d=a.relation;P2PTV.log("answering peer "+c+": "+d);var e=b._setupPeerConnection(c,d);e.pc.ondatachannel=function(a){e.channel=a.channel,e.setupDataChannel(),"parent"===d?b._parents[c]=e:b._children[c]=e},b._handleOffer(a,e);break;case"answer":P2PTV.log("received answer sdp from: "+a.id);var c=a.id,e=c in b._parents?b._parents[c]:b._children[c];b._handleAnswer(a,e);break;case"ice":P2PTV.log("received ice candidate from: "+a.id);var c=a.id;c in b._parents?b._handleIce(a,b._parents[c]):c in b._children&&b._handleIce(a,b._children[c])}},_pushData:function(a){var b=this;b._player.addData(a);for(var c in b._children)b._children.hasOwnProperty(c)&&b._children[c].send(a)},_setupPeerConnection:function(a){var b=this,a=new Peer(b,pid,relation);return a.pc=new RTCPeerConnection(P2PTV.ICE_SERVERS,P2PTV.PC_CONSTRAINTS),a.pc.onicecandidate=function(c){var d=c.candidate;d&&b._ws.send(JSON.stringify({type:"ice",id:a.id,sdp:d}))},a},_makeOffer:function(a){var b=this;a.pc.createOffer(function(c){P2PTV.log("created offer for: "+a.id),a.pc.setLocalDescription(c,function(){P2PTV.log("set local description for: "+a.id);var d=a.id in b._parents?"child":"parent";b._ws.send(JSON.stringify({type:"offer",relation:d,id:a.id,sdp:c.sdp}))},b._traceErr)},b._traceErr)},_makeAnswer:function(a){var b=this;a.pc.createAnswer(function(c){P2PTV.log("created answer for: "+a.id),a.pc.setLocalDescription(c,function(){P2PTV.log("set local description answer for: "+a.id),b._ws.send(JSON.stringify({type:"answer",id:a.id,sdp:c.sdp}))},b._traceErr)},b._traceErr)},_handleOffer:function(a,b){var c=this,d=new RTCSessionDescription(a);b.pc.setRemoteDescription(d,function(){P2PTV.log("set remote offer description for: "+b.id),c._makeAnswer(b)},c._traceErr)},_handleAnswer:function(a,b){var c=this,d=new RTCSessionDescription(a);b.pc.setRemoteDescription(d,function(){P2PTV.log("set remote answer description for: "+b.id)},c._traceErr)},_handleIce:function(a,b){var c=this,d=new RTCIceCandidate(a);b.pc.addIceCandidate(d,function(){P2PTV.log("successfully added ICE candidate for: "+b.id)},c._traceErr)},_traceErr:function(a){P2PTV.log(a)}},P2PTV.Stream.prototype.constructor=P2PTV.Stream,P2PTV.Player=function(a,b){var c=this;if(b=b||{},"string"!=typeof a)throw new Error("P2PTV Player expects stream id: "+a);c._streamId=a,c._width=854,c._height=480,c._parentElementId=b.parentElementId,c._initSegment=null,c._clusters={},c._timecodeQueue=[],c._appending=!1,c._isPlaying=!1,c._mediaSource=null,c._sourceBuffer=null,c._setupVideo(),c._reader=new FileReader,c._reader.onload=function(a){c._sourceBuffer.appendBuffer(new Uint8Array(a.target.result))}},P2PTV.Player.prototype={_setupVideo:function(){var a=this;a._mediaSource=new MediaSource;var b=document.getElementById(a._parentElementId);a._video=document.createElement("video"),a._video.id="p2ptv-"+a._streamId,a._video.controls=!0,a._video.width=a._width,a._video.height=a._height,a._video.src=window.URL.createObjectURL(a._mediaSource),a._video.pause(),b?(P2PTV.log("Appending stream "+a._streamId+" to "+a._parentElementId),b.appendChild(a._video)):(P2PTV.log("Appending stream "+a._streamId+" to body"),document.body.appendChild(a._video)),a._mediaSource.addEventListener("sourceopen",function(b){P2PTV.log("sourceopen");var c='video/webm; codecs="vorbis,vp8"';a._sourceBuffer=a._mediaSource.addSourceBuffer(c),a._sourceBuffer.addEventListener("updateend",function(){a._timecodeQueue.length>0&&a._appendMediaSegment(a._timecodeQueue.shift())},!1)},!1),a._mediaSource.addEventListener("sourceended",function(a){P2PTV.log("source ended")},!1),a._mediaSource.addEventListener("sourceclose",function(a){P2PTV.log("source closed")},!1)},_appendMediaSegment:function(a){var b=this;b._appending=!0,P2PTV.log("appending media segment: timecode="+a);var c=new Blob(b._clusters[a],{type:"video/webm"});b._reader.readAsArrayBuffer(c),b._isPlaying||(P2PTV.log("playing video"),b._isPlaying=!0,b._video.play()),delete b._clusters[a],b._appending=!1},addData:function(a){var b=this,c=new Float64Array(a),d=c[0],e=new Uint8Array(a,8),f=(new Int32Array(a),e[0]>>6);switch(f){case 0:var g=9+(7&e[0]);P2PTV.log("appending initialization segment: timecode="+d),b._sourceBuffer.appendBuffer(a.slice(g));break;case 1:var g=16+(7&e[0]),h=e[2],i=e[1],j=b._clusters[d];j?j[i]=a.slice(g):(j=new Array(h+1),j[i]=a.slice(g),b._clusters[d]=j),i+1===j.length&&(b._appending||0!==b._timecodeQueue.length?b._timecodeQueue.push(d):b._appendMediaSegment(d))}}},P2PTV.Player.prototype.constructor=P2PTV.Player,P2PTV.Peer=function(a,b,c){var d=this;if(d._client=a||null,null===d._client||void 0===d._client)throw new Error("Peer expects client reference");if(d.id=b||null,"string"!=typeof d.id)throw new Error("Peer expects valid identifier");if("parent"!==c&&"child"!==c)throw new Error("Peer expects valid relation");d.isParent="parent"===c,d.isChild=!d.isParent,d.pc=null,d.channel=null},P2PTV.Peer.prototype={send:function(a){var b=this;"open"===b.channel.readyState&&b.channel.send(a)},setupDataChannel:function(){var a=this;a.channel.binaryType="arraybuffer",a.channel.onopen=function(){var b=a.channel.readyState;if(P2PTV.log(P2PTV.CHANNEL+" state is: "+b),"open"===b){var c=P2PTV.CHANNEL+" test message";P2PTV.log('sent data channel message: "'+c+'"'),a.send(c)}},a.channel.onclose=function(){var b=a.channel.readyState;P2PTV.log(P2PTV.CHANNEL+" state is: "+b)},a.isParent?a.channel.onmessage=function(b){var c=b.data;"string"==typeof c?P2PTV.log("received "+P2PTV.CHANNEL+" string: "+c):a._client._pushData(c)}:a.channel.onmessage=function(a){var b=a.data;"string"==typeof b?P2PTV.log("received "+P2PTV.CHANNEL+" string: "+b):P2PTV.log("received "+P2PTV.CHANNEL+" ArrayBuffer: "+b.byteLength+" bytes")},a.channel.onerror=function(a){P2PTV.log(P2PTV.CHANNEL+" error: "+a.toString())},P2PTV.log("setup "+P2PTV.CHANNEL)}},P2PTV.Peer.prototype.constructor=P2PTV.Peer,P2PTV.Encoder=function(){},P2PTV.Encoder.prototype={},P2PTV.Encoder.prototype.constructor=P2PTV.Encoder,P2PTV.Decoder=function(){},P2PTV.Decoder.prototype={},P2PTV.Decoder.prototype.constructor=P2PTV.Decoder,P2PTV.InitSegment=function(){},P2PTV.InitSegment.prototype={},P2PTV.InitSegment.prototype.constructor=P2PTV.InitSegment,P2PTV.MediaSegment=function(){},P2PTV.MediaSegment.prototype={},P2PTV.MediaSegment.prototype.constructor=P2PTV.MediaSegment,P2PTV.Window=function(){},P2PTV.Window.prototype={},P2PTV.Window.prototype.constructor=P2PTV.Window;